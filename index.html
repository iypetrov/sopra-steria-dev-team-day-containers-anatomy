<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Contaoner's Anatomy</title>
    <link rel="icon" type="image/x-icon" href="public/small-logo.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.6.0/css/reveal.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.6.0/css/theme/white.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/xcode.min.css" />
</head>
<style>
    mark {
        background-color: #ececec;
        color: #c6241d;
        border-radius: 10px;
    }
</style>

<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <h2>container's anatomy</h2>
            </section>

            <section>
                <h2>Who am I?</h2>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="width: 50%;">
                        <ul>
                            <li>Ilia Petrov</li>
                            <li>Software Engineer ~3 years</li>
                            <li>Main interests in Backend, Infrastructure & Cloud</li>
                            <li>Currently working as a DevOps</li>
                        </ul>
                    </div>
                    <div style="width: 50%; text-align: center;">
                        <img src="public/me.jpg" alt="Description" style="max-width: 100%; height: auto; border: none;">
                    </div>
                </div>
            </section>

            <section>
                <h3>you can find all resources here</h3>
                <p>
                    <a href="https://github.com/iypetrov/sopra-steria-dev-team-day-bash-scripts" target="_blank">
                        https://github.com/iypetrov/sopra-steria-dev-team-day-containers-anatomy
                    </a>
                </p>
            </section>

            <section>
                <h3>agenda for today</h3>
                <ul>
                    <li>What is a container?</li>
                    <li>What problem does container solve?</li>
                    <li>Container vs VM</li>
                    <li>Docker vs Podman</li>
                    <li>Demo: building container from scratch</li>
                    <li>Q&A</li>
                </ul>
            </section>

            <section>
                <h2>What is a container?</h2>
                <ul>
                    <li>Lightweight, portable, self-contained executable images</li>
                    <li>Contains software applications and their dependencies</li>
                    <li>Deploy and run applications consistently across different environments</li>
                    <li>Managed by orchestration platforms like Kubernetes, Docker Swarm, HashiCorp Nomad</li>
                </ul>
            </section>

            <section>
                <h2>What problem does container solve?</h2>
                <ul>
                    <li>"It works on my machine" - environment consistency</li>
                    <li>Dependency hell - isolated application dependencies</li>
                    <li>Deployment complexity - fast, reliable deployments</li>
                    <li>Resource waste - better resource utilization</li>
                    <li>Scaling challenges - easy horizontal scaling</li>
                </ul>
            </section>

            <section>
                <h2>Container vs Virtual Machine</h2>
                <div style="display: flex; justify-content: space-between;">
                    <div style="width: 45%;">
                        <h3>Containers</h3>
                        <ul>
                            <li>OS Level virtualization</li>
                            <li>Shares host OS kernel</li>
                            <li>Small & Lightweight</li>
                            <li>Faster startup</li>
                            <li>Lower resource usage</li>
                            <li>Process-level isolation</li>
                        </ul>
                    </div>
                    <div style="width: 55%;">
                        <h3>Virtual Machines</h3>
                        <ul>
                            <li>Hardware level virtualization</li>
                            <li>Full guest OS</li>
                            <li>Big & Heavy</li>
                            <li>Slow startup</li>
                            <li>Higher resource usage</li>
                            <li>Hardware-level isolation</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section>
                <h2>Docker vs Podman</h2>
                <div style="display: flex; justify-content: space-between;">
                    <div style="width: 50%;">
                        <div style="width: 100%; text-align: center;">
                            <img src="public/docker.svg" alt="Description" style="max-width: 100%; height: auto; border: none; box-shadow: none; outline: none;">
                        </div>
                        <ul>
                            <li>Uses a background daemon(dockerd) to manage containers</li>
                            <li>Needs root level permissions</li>
                            <li>Central daemon = bigger attack surface</li>
                        </ul>
                    </div>
                    <div style="width: 50%;">
                        <div style="width: 100%; text-align: center;">
                            <img src="public/podman.svg" alt="Description" style="max-width: 100%; height: auto; border: none; box-shadow: none; outline: none;">
                        </div>
                        <ul>
                            <li>Daemonless — runs containers directly as user processes</li>
                            <li>Designed to run rootless by default</li>
                            <li>No daemon + rootless = more secure by design</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section>
                <section>
                    <h2>Building container from scratch</h2>
                </section>
                <section>
                    <h2>Linux concepts for a container</h2>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="width: 30%;">
                            <ul>
                                <li>Namespaces</li>
                                <li>Chroot</li>
                                <li>Cgroups</li>
                            </ul>
                        </div>
                        <div style="width: 70%; text-align: center;">
                            <img src="public/container.jpeg" alt="Description" style="max-width: 100%; height: auto; border: none;">
                        </div>
                    </div>
                </section>
                <section>
                    <h2>Starting point - just print the arguments</h2>
                    <pre><code class="language-diff">import sys

def run():
    cmd = sys.argv[2:]
    print(cmd)

# docker         run image cmd params
# python main.py run       cmd params
def main():
    if len(sys.argv) < 2:
        print("Usage: python main.py run command [args...]")
        sys.exit(1)

    if sys.argv[1] == "run":
        run()

if __name__ == "__main__":
    main()
                    </code></pre>
                </section> 
                <section>
                    <h2>now let's execute what we pass as arguments</h2>
                    <pre><code class="language-diff">+import os
 import subprocess                   
 ...

 def run():
     cmd = sys.argv[2:]
-    print(cmd)
+    os.execvp(cmd[0], cmd)
                    </code></pre>
                </section> 
                <section>
                    <h2>Namespaces</h2>
                    <blockquote style="width: 100%; font-style: italic; border-left: 4px solid #ccc; padding-left: 1em; color: #555;">
                        A namespace wraps a global system resource in an abstraction that makes it appear to the processes within the namespace that they have their own isolated instance of the global resource. Changes to the global resource are visible to other processes that are members of the namespace, but are invisible to other processes. One use of namespaces is to implement containers.
                    </blockquote>
                </section>
                <section>
                    <h2>Namespaces</h2>
                    <ul>
                        <li>Unix Timesharing System</li>
                        <li>Process IDs</li>
                        <li>Mounts</li>
                        <li>Network</li>
                        <li>User IDs</li>
                        <li>InterProcess Comms</li>
                    </ul>
                </section>
                <section>
                    <h2>Let's now create a namespace that restricts the hostname</h2>
                    <pre><code class="language-diff"> def run():
+    os.unshare(os.CLONE_NEWUTS)
     cmd = sys.argv[2:]
     os.execvp(cmd[0], cmd)
                    </code></pre>
                </section>
                <section>
                    <h2>Let's add a default hostname to the container</h2>
                    <pre><code class="language-diff"> import os
 import sys 
+import subprocess                   
 ...

  
 def run():
     os.unshare(os.CLONE_NEWUTS)
+    pid = os.fork()
+    if pid == 0:
+        child()
+    else:
+        os.waitpid(pid, 0)
+  
+def child():
+    subprocess.run(["hostname", "container"])
     cmd = sys.argv[2:]
     os.execvp(cmd[0], cmd)
                    </code></pre>
                </section>
                <section>
                    <h2>foo</h2>
                    <pre><code class="language-diff"> def run():
-    os.unshare(os.CLONE_NEWUTS)
+    os.unshare(os.CLONE_NEWUTS | os.CLONE_NEWPID)
...

 def child():
     subprocess.run(["hostname", "container"])
+    os.chroot("tinyroot")
+    os.chdir("/")
+    os.makedirs("/proc", exist_ok=True)
+    subprocess.run(["mount", "-t", "proc", "proc", "/proc"])
     cmd = sys.argv[2:]
     os.execvp(cmd[0], cmd)
                    </code></pre>
                </section>
                <section>
                    <h2>clean mount</h2>
                    <pre><code class="language-diff"> def child():
     subprocess.run(["hostname", "container"])
     os.chroot("tinyroot")
     os.chdir("/")
     os.makedirs("/proc", exist_ok=True)
     subprocess.run(["mount", "-t", "proc", "proc", "/proc"])
     cmd = sys.argv[2:]
+    pid = os.fork()
+    if pid == 0:
         os.execvp(cmd[0], cmd)
+    else:
+        os.waitpid(pid, 0)
+        subprocess.run(["umount", "/proc"])

                    </code></pre>
                </section>
                <section>
                    <h2>Cgroup</h2>
                    <blockquote style="width: 100%; font-style: italic; border-left: 4px solid #ccc; padding-left: 1em; color: #555;">
                        Control  groups,  usually referred to as cgroups, are a Linux kernel feature which allow processes to be organized into hierarchical groups whose usage of various types of resources can then be limited and monitored.  The kernel's cgroup interface is provided through a pseudo-filesystem called cgroupfs.  Grouping is implemented in  the core cgroup kernel code, while resource tracking and limits are implemented in a set of per-resource-type subsystems (memory, CPU, and so on).
                    </blockquote>
                </section>
                <section>
                    <h2>Cgroup</h2>
                    <ul>
                        <li>Memory</li>
                        <li>CPU</li>
                        <li>I/O</li>
                        <li>Process numbers</li>
                    </ul>
                </section>
                <section>
                    <h2>Cgroup</h2>
                    <pre><code class="language-diff"> def child():
     subprocess.run(["hostname", "container"])
+    cgroup()
...

+ def cgroup():
+     path = "/sys/fs/cgroup/soprasteria"
+     os.makedirs(path, exist_ok=True)
+     with open(os.path.join(path, "pids.max"), "w") as f:
+         f.write("20")
+     with open(os.path.join(path, "cgroup.procs"), "w") as f:
+         f.write(str(os.getpid()))
                    </code></pre>
                </section>
                <section>
                    <h2>Let's test it</h2>
                    <h1>:(){ :|: & };:</h1>
                </section>

            </section>

            </section>

            <section>
                <h2>q&a</h2>
            </section>

            <section>
                <h3>Thank you for your attention! ❤️</h3>
            </section>
        </div>
    </div>

    <footer style="position: fixed; bottom: 10px; left: 10px;">
        <img src="public/big-logo.svg" alt="Sopra Steria Logo" style="width: 18rem; height: auto;" />
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.6.0/js/reveal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script>
        Reveal.initialize({
            controls: true,
            progress: true,
            slideNumber: false,
            history: true,
            center: true,
            transition: 'slide'
        });
        hljs.highlightAll();
    </script>
</body>

</html>
